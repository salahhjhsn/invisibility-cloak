cam = webcam(1);

w = preview(cam);
static_image = snapshot(cam);
 
% define color here in hsv
h = 0.66;
s = 0.7;
v = 0.7;

while 1
    img = snapshot(cam);

    r = round(mean(mean(img(:,:,1))));

    gray = rgb2gray(img);
    bw = imbinarize(gray);

    hsv_img = rgb2hsv(img);
    
    r = img(:,:,1)<100;
    g = img(:,:,2)<120;
    b = img(:,:,3)>200;
    
    lower_h     = hsv_img(:,:,1)>(h-0.1);
    lower_s     = hsv_img(:,:,2)>(s-0.2);
    lower_v     = hsv_img(:,:,3)>(v-0.05);

    upper_h     = hsv_img(:,:,1)<(h+0.1);
    upper_s     = hsv_img(:,:,2)<(s+0.2);
    upper_v     = hsv_img(:,:,3)<(v+0.05);
    
    mask_rgb = r.*g.*b;
    
    mask_h = lower_h.*upper_h;
    mask_s = lower_s.*upper_s;
    mask_v = lower_v.*upper_v;

%     mask_temp = and(mask_h,mask_s);
%     mask = and(mask_temp,mask_v);
    
    mask = mask_h.*mask_s;
    
    red_filter = uint8(mask).*img;

    cloak = img - red_filter + static_image.*uint8(mask);

%     imshow(img);
%     imshow(gray);
%     imshow(red_filter);
%     imshow(mask);
%     imshow(red_filter);

    imshow(cloak);

    if ishghandle(w) ~= 1
        break;
    end
end

closePreview(cam);
close all;
clear cam;